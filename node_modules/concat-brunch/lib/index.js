// Generated by CoffeeScript 1.6.3
var ConcatBrunch, fs;

fs = require('fs');

module.exports = ConcatBrunch = (function() {
  ConcatBrunch.prototype.brunchPlugin = true;

  function ConcatBrunch(config) {
    var _ref, _ref1;
    this.config = config;
    this.files = (((_ref = this.config) != null ? (_ref1 = _ref.plugins) != null ? _ref1.concat : void 0 : void 0) || {}).files;
  }

  ConcatBrunch.prototype.onCompile = function(generatedFiles) {
    var destPath, options, productionOnly, source, sources, tempPath, toRemove, _i, _len, _ref;
    _ref = this.files;
    for (destPath in _ref) {
      options = _ref[destPath];
      sources = options.sources, toRemove = options.toRemove, productionOnly = options.productionOnly;
      if (!(productionOnly && this.config.env.indexOf('production') > -1)) {
        continue;
      }
      tempPath = "/tmp/concat_brunch_" + (Math.floor(Math.random() * 1024));
      if (fs.existsSync(tempPath)) {
        fs.unlinkSync(tempPath);
      }
      for (_i = 0, _len = sources.length; _i < _len; _i++) {
        source = sources[_i];
        fs.appendFileSync(tempPath, fs.readFileSync(source));
        if (toRemove) {
          fs.unlinkSync(source);
        }
      }
      fs.renameSync(tempPath, destPath);
    }
  };

  return ConcatBrunch;

})();
